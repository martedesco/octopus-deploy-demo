name: ðŸŽ¯ Multi-Tenant Deploy (Dynamic Selection)

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/**'
      - '.github/workflows/dynamic-tenant-deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      tenants:
        description: 'Tenants to deploy (comma-separated) or "all"'
        required: true
        default: 'all'
        type: string
      test_mode:
        description: 'Test mode (faster execution)'
        required: true
        default: true
        type: boolean

jobs:
  setup:
    name: ðŸ”§ Setup Deployment Matrix
    runs-on: ubuntu-latest
    outputs:
      tenants: ${{ steps.tenants.outputs.matrix }}
      deployment_count: ${{ steps.tenants.outputs.count }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸŽ¯ Generate tenant matrix
        id: tenants
        run: |
          # Read the base tenant configuration
          BASE_TENANTS=$(cat .github/tenants.json)
          
          if [ "${{ github.event.inputs.tenants }}" = "all" ]; then
            echo "ðŸ“‹ Deploying to all tenants"
            TENANTS="$BASE_TENANTS"
          else
            echo "ðŸŽ¯ Deploying to specific tenants: ${{ github.event.inputs.tenants }}"
            # Create filtered tenant list based on input
            INPUT_TENANTS="${{ github.event.inputs.tenants }}"
            # Clean up the input - remove brackets, spaces, and split by comma
            CLEAN_INPUT=$(echo "$INPUT_TENANTS" | tr -d '[]' | tr -d ' ')
            IFS=',' read -ra TENANT_ARRAY <<< "$CLEAN_INPUT"
            
            # Start with empty include array
            FILTERED_TENANTS='{"include":[]}'
            
            for tenant in "${TENANT_ARRAY[@]}"; do
              if [ ! -z "$tenant" ]; then
                echo "ðŸ” Looking for tenant: $tenant"
                TENANT_CONFIG=$(echo "$BASE_TENANTS" | jq ".include[] | select(.name == \"$tenant\")")
                if [ ! -z "$TENANT_CONFIG" ] && [ "$TENANT_CONFIG" != "null" ]; then
                  echo "âœ… Found tenant: $tenant"
                  FILTERED_TENANTS=$(echo "$FILTERED_TENANTS" | jq ".include += [$TENANT_CONFIG]")
                else
                  echo "âš ï¸ Warning: Tenant '$tenant' not found in configuration"
                fi
              fi
            done
            
            TENANTS="$FILTERED_TENANTS"
          fi
          
          # Environment filtering logic
          if [ "${{ github.event.inputs.environment }}" = "production" ]; then
            echo "ðŸŽ¯ Filtering tenants for production environment (excluding startup-demo)"
            TENANTS=$(echo "$TENANTS" | jq '{include: [.include[] | select(.name != "startup-demo")]}')
          else
            echo "ðŸŽ¯ Using tenants for staging environment (all tenants supported)"
          fi
          
          # Count the final tenant list
          COUNT=$(echo "$TENANTS" | jq '.include | length')
          
          # Ensure we have at least one tenant
          if [ "$COUNT" -eq 0 ]; then
            echo "âŒ Error: No valid tenants found for deployment"
            echo "Available tenants: $(echo "$BASE_TENANTS" | jq -r '.include[].name' | tr '\n' ' ')"
            exit 1
          fi
          
          # Compact the JSON for output
          TENANTS_COMPACT=$(echo "$TENANTS" | jq -c .)
          
          echo "matrix=$TENANTS_COMPACT" >> $GITHUB_OUTPUT
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š Deployment Summary:"
          echo "   Environment: ${{ github.event.inputs.environment }}"
          echo "   Tenant Count: $COUNT"
          echo "   Test Mode: ${{ github.event.inputs.test_mode }}"
          echo "   Generated Matrix: $TENANTS_COMPACT"

  test:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ðŸ“¥ Install dependencies
        run: npm ci
      
      - name: ðŸ§ª Run tests
        run: npm test
      
      - name: ðŸ—ï¸ Build application
        run: npm run build

  deploy:
    name: ðŸš€ Deploy to ${{ matrix.name }}
    needs: [setup, test]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped') && needs.setup.outputs.deployment_count != '0'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.tenants) }}
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ðŸ“¥ Install dependencies
        run: npm ci
      
      - name: ðŸ—ï¸ Build application
        run: npm run build
      
      - name: ðŸ”§ Configure tenant environment
        run: |
          echo "ðŸ”§ Setting up environment for ${{ matrix.name }}"
          echo "TENANT_ID=${{ matrix.name }}" >> tenant.env
          echo "ENVIRONMENT=${{ github.event.inputs.environment }}" >> tenant.env
          echo "DATABASE_URL=${{ matrix.database }}" >> tenant.env
          echo "API_URL=${{ matrix.api_url }}" >> tenant.env
          echo "REGION=${{ matrix.region }}" >> tenant.env
          echo "PORT=${{ matrix.port }}" >> tenant.env
          
          echo "ðŸ“‹ Tenant Configuration:"
          cat tenant.env
      
      - name: ðŸš€ Deploy to ${{ matrix.name }}
        run: |
          source tenant.env
          
          echo "ðŸš€ Starting deployment for ${{ matrix.name }}"
          echo "ðŸŒ Region: ${{ matrix.region }}"
          echo "ðŸ·ï¸ Environment: ${{ github.event.inputs.environment }}"
          echo "ðŸ—„ï¸ Database: ${{ matrix.database }}"
          
          # Simulate pre-deployment checks
          echo "ðŸ” Running pre-deployment checks..."
          if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
            sleep 1
          else
            sleep 2
          fi
          
          # Simulate database migration (if needed)
          if [ "${{ github.event.inputs.environment }}" = "production" ]; then
            echo "ðŸ—„ï¸ Running database migrations..."
            if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
              sleep 1
            else
              sleep 3
            fi
          fi
          
          # Simulate deployment
          echo "ðŸ“¦ Deploying application..."
          npm run deploy
          if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
            sleep 2
          else
            sleep 4
          fi
          
          echo "âœ… Deployment completed for ${{ matrix.name }}!"
          echo "ðŸ”— Application available at: ${{ matrix.api_url }}"
        
        env:
          TENANT_CONFIG: ${{ toJson(matrix) }}
      
      - name: ðŸ” Health check
        run: |
          echo "ðŸ” Performing health check for ${{ matrix.name }}..."
          
          # Simulate health check
          if [ "${{ github.event.inputs.environment }}" = "production" ]; then
            echo "ðŸ¥ Production health check (comprehensive)..."
            if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
              sleep 1
            else
              sleep 3
            fi
          else
            echo "ðŸ¥ Staging health check (basic)..."
            sleep 1
          fi
          
          echo "âœ… Health check passed for ${{ matrix.name }}"
          echo "ðŸ“Š Response time: $(shuf -i 50-200 -n 1)ms"
          echo "ðŸ’¾ Memory usage: $(shuf -i 45-85 -n 1)%"
          echo "ðŸ”¢ Active connections: $(shuf -i 10-100 -n 1)"
      
      - name: ðŸ“¢ Deployment notification
        run: |
          echo "ðŸ“¢ Sending deployment notification..."
          echo "âœ… ${{ matrix.name }} successfully deployed to ${{ github.event.inputs.environment }}"
          echo "ðŸ• Completed at: $(date)"
          
          # Feature-specific notifications
          if [ "${{ matrix.features.premium_support }}" = "true" ]; then
            echo "ðŸŽ¯ Premium support team notified"
          fi
          
          if [ "${{ matrix.features.analytics }}" = "true" ]; then
            echo "ðŸ“Š Analytics tracking enabled"
          fi

  summary:
    name: ðŸ“‹ Deployment Summary
    needs: [setup, deploy]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“Š Generate deployment report
        run: |
          echo "## ðŸš€ Multi-Tenant Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Total Tenants:** ${{ needs.setup.outputs.deployment_count }}" >> $GITHUB_STEP_SUMMARY
          echo "**Test Mode:** ${{ github.event.inputs.test_mode }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Time:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.deploy.result }}" = "success" ]; then
            echo "âœ… **Status:** All deployments completed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** Some deployments failed" >> $GITHUB_STEP_SUMMARY
          fi