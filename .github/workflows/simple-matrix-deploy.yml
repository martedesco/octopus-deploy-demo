name: ðŸš€ Simple Matrix Deployment

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'scripts/**'
      - '.github/workflows/simple-matrix-deploy.yml'
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: 'Override deployment environment'
        required: false
        default: 'auto'
        type: choice
        options:
        - auto
        - staging
        - production
      test_mode:
        description: 'Run in test mode (faster execution)'
        required: false
        default: true
        type: boolean

jobs:
  test:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ðŸ“¥ Install dependencies
        run: npm ci
      
      - name: ðŸ§ª Run tests
        run: npm test
      
      - name: ðŸ—ï¸ Build application
        run: npm run build

  deploy:
    name: ðŸš€ Deploy to Tenants
    needs: test
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        tenant: [acme-corp, beta-solutions, startup-demo]
        environment: [staging, production]
        exclude:
          # Don't deploy startup-demo to production
          - tenant: startup-demo
            environment: production
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ðŸ“¥ Install dependencies
        run: npm ci
      
      - name: ðŸ—ï¸ Build application
        run: npm run build
      
      - name: ðŸ”§ Check if deployment should proceed
        id: should-deploy
        run: |
          # Check if we should deploy based on environment override
          if [ "${{ github.event.inputs.deploy_environment }}" = "auto" ] || [ "${{ github.event.inputs.deploy_environment }}" = "" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "ðŸŽ¯ Auto mode: deploying to ${{ matrix.environment }}"
          elif [ "${{ github.event.inputs.deploy_environment }}" = "${{ matrix.environment }}" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "ðŸŽ¯ Environment match: deploying to ${{ matrix.environment }}"
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Skipping: ${{ matrix.environment }} doesn't match override ${{ github.event.inputs.deploy_environment }}"
          fi
      
      - name: ðŸ”§ Configure deployment environment
        if: steps.should-deploy.outputs.should_deploy == 'true'
        id: deploy-config
        run: |
          if [ "${{ github.event.inputs.deploy_environment }}" = "auto" ] || [ "${{ github.event.inputs.deploy_environment }}" = "" ]; then
            DEPLOY_ENV="${{ matrix.environment }}"
          else
            DEPLOY_ENV="${{ github.event.inputs.deploy_environment }}"
          fi
          
          echo "deployment_env=$DEPLOY_ENV" >> $GITHUB_OUTPUT
          echo "ðŸŽ¯ Using deployment environment: $DEPLOY_ENV"
          echo "ðŸ§ª Test mode enabled: ${{ github.event.inputs.test_mode }}"
      
      - name: ðŸš€ Deploy to ${{ matrix.tenant }} - ${{ steps.deploy-config.outputs.deployment_env }}
        if: steps.should-deploy.outputs.should_deploy == 'true'
        run: |
          echo "ðŸ—ï¸ Deploying to tenant: ${{ matrix.tenant }}"
          echo "ðŸŒ Environment: ${{ steps.deploy-config.outputs.deployment_env }}"
          echo "â° Deployment time: $(date)"
          echo "ðŸ§ª Test mode: ${{ github.event.inputs.test_mode }}"
          
          # Simulate deployment process with faster timing in test mode
          if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
            echo "ðŸ“¦ Preparing deployment package (test mode - faster)..."
            sleep 1
            
            echo "ðŸ”§ Configuring tenant-specific settings..."
            sleep 1
            
            echo "ðŸ“¤ Uploading to ${{ matrix.tenant }} servers..."
            sleep 1
          else
            echo "ðŸ“¦ Preparing deployment package..."
            sleep 2
            
            echo "ðŸ”§ Configuring tenant-specific settings..."
            sleep 1
            
            echo "ðŸ“¤ Uploading to ${{ matrix.tenant }} servers..."
            sleep 3
          fi
          
          echo "âœ… Deployment completed successfully!"
          echo "ðŸ”— Application URL: https://${{ matrix.tenant }}-${{ steps.deploy-config.outputs.deployment_env }}.example.com"
        
        env:
          TENANT_ID: ${{ matrix.tenant }}
          ENVIRONMENT: ${{ steps.deploy-config.outputs.deployment_env }}
          DATABASE_URL: ${{ matrix.tenant }}_${{ steps.deploy-config.outputs.deployment_env }}_db
          API_URL: https://api.${{ matrix.tenant }}.com
      
      - name: ðŸ” Post-deployment verification
        if: steps.should-deploy.outputs.should_deploy == 'true'
        run: |
          echo "ðŸ” Running health checks for ${{ matrix.tenant }}..."
          
          if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
            sleep 1
          else
            sleep 2
          fi
          
          echo "âœ… Health check passed"
          echo "ðŸ“Š Performance metrics collected"
          echo "ðŸ”” Notifications sent"
          
          # Show some mock metrics
          echo "ðŸ“ˆ Response time: $(shuf -i 45-120 -n 1)ms"
          echo "ðŸ’¾ Memory usage: $(shuf -i 40-75 -n 1)%"
          echo "ðŸ”¢ Active connections: $(shuf -i 15-85 -n 1)"

  summary:
    name: ðŸ“‹ Deployment Summary
    needs: [test, deploy]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“Š Generate deployment report
        run: |
          echo "## ðŸš€ Simple Matrix Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment Override:** ${{ github.event.inputs.deploy_environment || 'auto' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Test Mode:** ${{ github.event.inputs.test_mode || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Time:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.deploy.result }}" = "success" ]; then
            echo "âœ… **Status:** All deployments completed successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸŽ¯ Deployed Tenants:" >> $GITHUB_STEP_SUMMARY
            echo "- acme-corp" >> $GITHUB_STEP_SUMMARY
            echo "- beta-solutions" >> $GITHUB_STEP_SUMMARY
            echo "- startup-demo (staging only)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** Some deployments failed" >> $GITHUB_STEP_SUMMARY
          fi